{% extends "base.html" %} {% block title %}Reset Password - LunaLink{% endblock
%} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/auth.css') }}"
/>
{% endblock %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <div class="auth-logo">
        <i class="fas fa-moon"></i>
        <h1>LunaLink</h1>
      </div>
      <p class="auth-subtitle">Create a new password for your account</p>
    </div>

    <form
      method="POST"
      action="{{ url_for('auth.reset_password', email=email, otp=otp) }}"
      class="auth-form"
      id="resetForm"
    >
      <div class="form-group">
        <label class="form-label">New Password</label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input
            type="password"
            name="password"
            id="password"
            class="form-input"
            placeholder="Enter new password"
            required
          />
          <button
            type="button"
            class="password-toggle"
            onclick="togglePassword(this)"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-strength">
          <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <span class="strength-text" id="strengthText">Password strength</span>
        </div>
        <div class="password-requirements" id="passwordRequirements">
          <div class="requirement" id="reqLength">
            <i class="fas fa-times"></i>
            <span>At least 8 characters</span>
          </div>
          <div class="requirement" id="reqLowercase">
            <i class="fas fa-times"></i>
            <span>One lowercase letter</span>
          </div>
          <div class="requirement" id="reqUppercase">
            <i class="fas fa-times"></i>
            <span>One uppercase letter</span>
          </div>
          <div class="requirement" id="reqNumber">
            <i class="fas fa-times"></i>
            <span>One number</span>
          </div>
          <div class="requirement" id="reqSpecial">
            <i class="fas fa-times"></i>
            <span>One special character</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Confirm New Password</label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input
            type="password"
            name="confirm_password"
            id="confirmPassword"
            class="form-input"
            placeholder="Confirm new password"
            required
          />
          <button
            type="button"
            class="password-toggle"
            onclick="togglePassword(this)"
          >
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-match" id="passwordMatch">
          <i class="fas fa-check"></i>
          <span>Passwords match</span>
        </div>
      </div>

      <button type="submit" class="btn btn-primary auth-btn" id="submitBtn">
        <i class="fas fa-sync-alt"></i>
        Reset Password
      </button>
    </form>

    <div class="auth-footer">
      <p>
        Remember your password?
        <a href="{{ url_for('auth.login') }}" class="auth-link">Sign in here</a>
      </p>
    </div>
  </div>

  <div class="auth-decoration">
    <div class="floating-hearts-auth">
      {% for i in range(8) %}
      <div class="heart-auth" style="--i: {{ i }};"></div>
      {% endfor %}
    </div>
    <div class="decoration-content">
      <h2>Fresh Start üîê</h2>
      <p>
        Create a strong new password to keep your love space secure and private.
      </p>
      <div class="decoration-features">
        <div class="decoration-item">
          <i class="fas fa-shield-alt"></i>
          <span>Enhanced Security</span>
        </div>
        <div class="decoration-item">
          <i class="fas fa-heart"></i>
          <span>Private Access</span>
        </div>
        <div class="decoration-item">
          <i class="fas fa-rocket"></i>
          <span>Quick Setup</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");
    const strengthFill = document.getElementById("strengthFill");
    const strengthText = document.getElementById("strengthText");
    const passwordMatch = document.getElementById("passwordMatch");
    const passwordRequirements = document.getElementById(
      "passwordRequirements"
    );
    const submitBtn = document.getElementById("submitBtn");

    function validatePassword(password) {
      const requirements = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^a-zA-Z0-9]/.test(password),
      };

      return requirements;
    }

    function updatePasswordRequirements(requirements) {
      Object.keys(requirements).forEach((key) => {
        const requirementElement = document.getElementById(
          `req${key.charAt(0).toUpperCase() + key.slice(1)}`
        );
        const icon = requirementElement.querySelector("i");

        if (requirements[key]) {
          icon.className = "fas fa-check";
          requirementElement.style.color = "#4caf50";
        } else {
          icon.className = "fas fa-times";
          requirementElement.style.color = "#f44336";
        }
      });
    }

    function checkPasswordStrength(password) {
      const requirements = validatePassword(password);
      const metRequirements =
        Object.values(requirements).filter(Boolean).length;
      const totalRequirements = Object.keys(requirements).length;
      const strength = (metRequirements / totalRequirements) * 100;

      let feedback = "";
      switch (metRequirements) {
        case 0:
        case 1:
          feedback = "Very Weak";
          break;
        case 2:
          feedback = "Weak";
          break;
        case 3:
          feedback = "Medium";
          break;
        case 4:
          feedback = "Strong";
          break;
        case 5:
          feedback = "Very Strong";
          break;
      }

      return { strength, feedback, requirements };
    }

    function updatePasswordStrength() {
      const password = passwordInput.value;
      const { strength, feedback, requirements } =
        checkPasswordStrength(password);

      strengthFill.style.width = strength + "%";
      strengthText.textContent = feedback;

      if (strength < 40) {
        strengthFill.style.background = "#f44336";
      } else if (strength < 70) {
        strengthFill.style.background = "#ff9800";
      } else {
        strengthFill.style.background = "#4caf50";
      }

      updatePasswordRequirements(requirements);
      updateSubmitButtonState();
    }

    function checkPasswordMatch() {
      const password = passwordInput.value;
      const confirm = confirmInput.value;

      if (confirm.length === 0) {
        passwordMatch.style.display = "none";
      } else if (password === confirm) {
        passwordMatch.style.display = "flex";
        passwordMatch.style.color = "#4caf50";
        passwordMatch.innerHTML =
          '<i class="fas fa-check"></i><span>Passwords match</span>';
      } else {
        passwordMatch.style.display = "flex";
        passwordMatch.style.color = "#f44336";
        passwordMatch.innerHTML =
          '<i class="fas fa-times"></i><span>Passwords do not match</span>';
      }

      updateSubmitButtonState();
    }

    function updateSubmitButtonState() {
      const password = passwordInput.value;
      const confirm = confirmInput.value;
      const { strength, requirements } = checkPasswordStrength(password);

      const allRequirementsMet = Object.values(requirements).every(Boolean);
      const passwordsMatch = password === confirm && password.length > 0;

      if (allRequirementsMet && passwordsMatch) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = "1";
        submitBtn.style.cursor = "pointer";
      } else {
        submitBtn.disabled = true;
        submitBtn.style.opacity = "0.6";
        submitBtn.style.cursor = "not-allowed";
      }
    }

    function togglePassword(button) {
      const input = button.parentElement.querySelector("input");
      const icon = button.querySelector("i");

      if (input.type === "password") {
        input.type = "text";
        icon.className = "fas fa-eye-slash";
      } else {
        input.type = "password";
        icon.className = "fas fa-eye";
      }
    }

    passwordInput.addEventListener("input", updatePasswordStrength);
    passwordInput.addEventListener("input", checkPasswordMatch);
    confirmInput.addEventListener("input", checkPasswordMatch);

    // Initialize
    updatePasswordStrength();
    checkPasswordMatch();

    // Form submission validation
    document
      .getElementById("resetForm")
      .addEventListener("submit", function (e) {
        const password = passwordInput.value;
        const confirm = confirmInput.value;

        if (password !== confirm) {
          e.preventDefault();
          showNotification("Passwords do not match!", "error");
          return;
        }

        const { requirements } = checkPasswordStrength(password);
        const allRequirementsMet = Object.values(requirements).every(Boolean);

        if (!allRequirementsMet) {
          e.preventDefault();
          showNotification("Please meet all password requirements", "error");
          return;
        }

        // Add loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.classList.add("loading");
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Resetting Password...';
      });
  });
</script>

<style>
  .password-requirements {
    margin-top: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  }

  .requirement {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 0.85rem;
    transition: color 0.3s ease;
  }

  .requirement:last-child {
    margin-bottom: 0;
  }

  .requirement i {
    font-size: 0.8rem;
    width: 16px;
    text-align: center;
  }
</style>
{% endblock %}
